<template>
	<view class="apply">
		<view class="list">
			<view class="line">
				<view class="title">店铺资料</view>
				<view>
					<view>
						<text>店铺名称</text>
						<input type="text" v-model="apply.storeName" placeholder="请输入店铺名称" />
					</view>
					<view>
						<text>联系人</text>
						<input type="text" v-model="apply.linkMan" placeholder="请输入联系人" />
					</view>
					<view>
						<text>联系电话</text>
						<input type="number" maxlength="11" v-model="apply.mobile" placeholder="请输入联系电话" />
					</view>
					<view>
						<text>所在地区</text>
						<view @click="showMulLinkageThreePicker">{{ params.location_p ? params.location_p + '-' + params.location_c + '-' + params.location_a : citys }}</view>
					</view>
					<view>
						<text>详细地址</text>
						<textarea v-model="apply.storeAddress" :disabled="true" placeholder="请选择详细地址" @click="choseAddrDetail" style="height: 80upx;"></textarea>
					</view>
					<view>
						<text>所售类目</text>
						<view @click="showSinglePicker">{{ apply.category }}</view>
					</view>
				</view>
				<view class="arge">
					<checkbox-group class="checkbox" @change="checkboxChange"><checkbox class="red round text-xl" :value="!apply.agree" :checked="apply.agree" /></checkbox-group>
					<view class="text">
						我已经阅读并同意
						<text @click="close">《入住协议》</text>
					</view>
				</view>
			</view>
			<view class="btn flex flex-direction"><button type="warn" class="cu-btn round lg bg-red" :disabled="disabled" @click="submitApply">提交</button></view>
		</view>
		<mpvue-picker
			:themeColor="themeColor"
			ref="mpvuePicker"
			:mode="mode"
			:deepLength="deepLength"
			:pickerValueDefault="pickerValueDefault"
			@onConfirm="onPickerComfirm"
			@onCancel="onCancel"
			:pickerValueArray="pickerValueArray"
		></mpvue-picker>
		<mpvue-city-picker :themeColor="themeColor" ref="mpvueCityPicker" :pickerValueDefault="cityPickerValueDefault" @onCancel="onCancel" @onConfirm="onConfirm"></mpvue-city-picker>
		<alert-rich :text="agre" v-if="showAgre" @on-close="close"></alert-rich>
	</view>
</template>

<script>
import mpvueCityPicker from '@/components/mpvue-citypicker/mpvueCityPicker';
import mpvuePicker from '@/components/mpvue-citypicker/mpvuePicker.vue';

import AlertRich from '@/components/richtext';
import gcoord from 'gcoord';

export default {
	name: 'apply',
	components: { mpvueCityPicker, AlertRich, mpvuePicker },
	data() {
		return {
			citys: '请选择地区',
			disabled: false,
			themeColor: '#007AFF',
			agre: '',
			showAgre: false,
			cityPickerValueDefault: [0, 0, 1],
			mode: '',
			deepLength: 1,
			pickerValueDefault: [0],
			pickerValueArray: [],
			params: {
				location_p: '',
				location_a: '',
				location_c: ''
			},
			items: [{ name: 'agre' }],
			apply: {
				linkMan: '',
				mobile: '',
				storeName: '',
				area: '',
				storeAddress: '',
				latitude: '', // 经度
				longitude: '', // 维度
				category: '请选择类目',
				typeId: '',
				agree: false
			}
		};
	},
	onLoad() {
		this.getStoreTypeList();
	},
	methods: {
		close() {
			this.showAgre = !this.showAgre;
		},
		onCancel(e) {},
		showMulLinkageThreePicker() {
			this.$refs.mpvueCityPicker.show();
		},
		// 单列
		showSinglePicker() {
			this.mode = 'selector';
			this.deepLength = 1;
			this.pickerValueDefault = [0];
			this.$refs.mpvuePicker.show();
		},
		onConfirm(e) {
			const city = e.label.split('-');
			this.params.location_p = city[0];
			this.params.location_c = city[1];
			this.params.location_a = city[2];
			this.apply.area = e.cityCode;
		},
		onPickerComfirm(e) {
			this.apply.category = e.label;
			this.apply.typeId = e.value[0];
		},
		checkboxChange(e) {
			this.apply.agree = !this.apply.agree;
		},
		// 选择详细地址
		choseAddrDetail() {
			let _this = this;
			uni.chooseLocation({
				success: function(res) {
					console.log('位置名称：' + res.name);
					console.log('详细地址：' + res.address);
					console.log('纬度：' + res.latitude);
					console.log('经度：' + res.longitude);
					_this.apply.storeAddress = res.address;
					let result = gcoord.transform(
						[res.longitude, res.latitude], // 经纬度坐标
						gcoord.GCJ02, // 当前坐标系
						gcoord.BD09 // 目标坐标系
					);
					_this.apply.longitude = result[0];
					_this.apply.latitude = result[1];
				}
			});
		},
		// 获取商户类型
		async getStoreTypeList() {
			const { data } = await this.$http.storeTypeList();
			this.pickerValueArray = data;
			_.map(this.pickerValueArray, item => {
				item.label = item.name;
				item.value = item.id;
			});
		},
		// 提交订单
		submitApply() {
			if (this.checkForm()) {
				this.$http.storeEntity(this.apply).then(res => {
					if (res.code == 200) {
						uni.showToast({ title: '入驻成功', icon: 'none' });
						setTimeout(()=>{
							uni.navigateBack();
						}, 1000)
					}else{
						uni.showToast({ title: '入驻成功', icon: 'none' });
					}
				});
			}
		},
		// 检验
		checkForm() {
			if (!this.apply.agree) {
				uni.showToast({ title: '请先勾选用户协议', icon: 'none' });
				return false;
			}
			if (this.apply.linkMan == '') {
				uni.showToast({ title: '请输入联系人姓名', icon: 'none' });
				return false;
			}
			if (this.apply.mobile == '') {
				uni.showToast({ title: '请输入手机号', icon: 'none' });
				return false;
			}
			if (this.apply.mobile.length !== 11) {
				uni.showToast({ title: '请输入正确的手机号', icon: 'none' });
				return false;
			}
			if (this.apply.area == '') {
				uni.showToast({ title: '请选择所在地区', icon: 'none' });
				return false;
			}
			if (this.apply.storeAddress == '') {
				uni.showToast({ title: '请选择详情地址', icon: 'none' });
				return false;
			}
			if (this.apply.typeId == '') {
				uni.showToast({ title: '请选择类目', icon: 'none' });
				return false;
			}

			return true;
		}
	}
};
</script>

<style lang="scss">
.apply {
	.list {
		.line {
			.title {
				height: 80upx;
				line-height: 80upx;
				font-size: 26upx;
				padding: 0 15px;
				& + view {
					padding: 0 15px;
					background-color: white;
					& > view {
						display: flex;
						justify-content: space-between;
						align-items: center;
						padding: 24upx 0;
						position: relative;
						&:last-of-type {
							&::after {
								display: none;
							}
						}
						&::after {
							position: absolute;
							content: '';
							border-bottom: 1px solid #f3f3f3;
							left: 0;
							bottom: 0;
							width: 100%;
						}
						& > text {
							font-size: 26upx;
							width: 120upx;
							text-align: justify;
							text-align-last: justify;
							padding-right: 30upx;
						}
						& > view,
						& > navigator {
							flex: 1;
							padding: 5upx 0;
							font-size: 26upx;
							color: #999;
							& > .picker-item {
								font-size: 26upx;
								text-align: left;
								line-height: 1.5;
							}
							& > view {
								&.sex {
									display: flex;
									& > view {
										width: 35upx;
										height: 35upx;
										border: 1px solid #e3e3e3;
										border-radius: 50%;
										box-sizing: border-box;
										margin-right: 80upx;
										&.act {
											background: #ec0000;
											border-color: #ec0000;
											position: relative;
											&::after {
												position: absolute;
												content: '\393';
												top: 0;
												left: 0;
												width: 100%;
												height: 100%;
												color: white;
												text-align: center;
												transform: rotate(-135deg);
												font-size: 22upx;
											}
											& > text {
												color: #ec0000;
											}
										}
										& > text {
											color: #808080;
											padding-left: 45upx;
										}
									}
								}
							}
						}
						& > input {
							font-size: 26upx;
							flex: 1;
						}
						& > picker {
							font-size: 26upx;
						}
					}
				}
			}
			& > .arge {
				margin: 15px;
				display: flex;
				align-items: center;
				.text {
					margin-left: 10upx;
					font-size: 28upx;
					text {
						color: #0500e8;
					}
				}
			}
		}
		.btn {
			margin: 60upx 15px 0;
		}
	}
}
</style>
